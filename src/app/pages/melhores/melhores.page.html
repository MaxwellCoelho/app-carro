<ion-content #IonContent [fullscreen]="true" [scrollEvents]="true" (ionScroll)="handleScroll($event)">
  <app-loader [showLoader]="showLoader"></app-loader>

  <ion-icon *ngIf="showTopButton" class="bt-top" name="arrow-up-circle" size="large" color="primary" (click)="up()"></ion-icon>

  <div class="main-container">
    <ion-title size="large" color="primary" class="main-title">
      <ion-icon [name]="nav.best.icon + '-outline'" color="secondary"></ion-icon>
      <ion-label>{{nav.best.title}} avaliados</ion-label>
    </ion-title>

    <div class="podium">
      <div class="car">
        <div class="nota nota-second">
          <ion-label *ngIf="podium[1]">
            <ion-icon name="ribbon" color="dark"></ion-icon>
            <strong>{{podium[1].model_average?.toFixed(2)}}</strong>{{podium[1].average?.name}}<br>
          </ion-label>

          <ion-label *ngIf="!podium[1]" class="no-car">
            <ion-icon name="ribbon" color="dark"></ion-icon>
            <strong>0.0</strong>Nenhum<br>
          </ion-label>
        </div>
        <div class="car-img-container">
          <img *ngIf="!podium[1]" class="no-car" [id]="'item-img-no-car-2'" src="assets/models/no-model.png" title="Nenhum carro no momento" alt="Nenhum carro no momento">
          <img *ngIf="podium[1]" [id]="'item-img-'+podium[1].name" src="assets/models/{{podium[1].brand?.url}}/{{podium[1].url}}/{{podium[1].img}}"
            title="{{podium[1].brand?.name + ' ' + podium[1].name}}" alt="{{podium[1].brand?.name + ' ' + podium[1].name}}"
            onerror="if (this.src != 'assets/models/no-model.png') this.src = 'assets/models/no-model.png'" (click)="clickCarItem($event, podium[1].brand?.url, podium[1]?.url)">
        </div>
        <div class="position left top second bottom">
          <div *ngIf="podium[1]" class="marca">
            <img src="assets/brands/{{podium[1].brand?.url}}.svg" title="{{podium[1].brand?.name}}" alt="{{podium[1].brand?.name}}"
            onerror="if (this.src != 'assets/brands/no-brand.svg') this.src = 'assets/brands/no-brand.svg'" class="brand-image-title">
          </div>
          <div *ngIf="podium[1]" class="nome">
            <span>{{podium[1].brand?.name}}</span> <strong>{{podium[1].name}}</strong>
          </div>

          <div *ngIf="!podium[1]" class="marca">
            <img src="assets/brands/no-brand.svg" title="Nenhum ainda" alt="Nenhum ainda" class="brand-image-title">
          </div>
          <div *ngIf="!podium[1]" class="nome">
            <strong>Nenhum Ainda!</strong>
          </div>
        </div>
      </div>
      <div class="car">
        <div class="nota nota-first">
          <ion-label *ngIf="podium[0]">
            <ion-icon name="ribbon" color="dark"></ion-icon>
            <strong>{{podium[0].model_average?.toFixed(2)}}</strong>{{podium[0].average?.name}}<br>
          </ion-label>

          <ion-label *ngIf="!podium[0]" class="no-car">
            <ion-icon name="ribbon" color="dark"></ion-icon>
            <strong>0.0</strong>Nenhum<br>
          </ion-label>
        </div>
        <div class="car-img-container">
          <img *ngIf="!podium[0]" class="no-car" [id]="'item-img-no-car-1'" src="assets/models/no-model.png" title="Nenhum carro no momento" alt="Nenhum carro no momento">
          <img *ngIf="podium[0]" [id]="'item-img-'+podium[0].name" src="assets/models/{{podium[0].brand?.url}}/{{podium[0].url}}/{{podium[0].img}}"
            title="{{podium[0].brand?.name + ' ' + podium[0].name}}" alt="{{podium[0].brand?.name + ' ' + podium[0].name}}"
            onerror="if (this.src != 'assets/models/no-model.png') this.src = 'assets/models/no-model.png'" (click)="clickCarItem($event, podium[0].brand?.url, podium[0]?.url)">
        </div>
        <div class="position left right top first">
          <div *ngIf="podium[0]" class="marca">
            <img src="assets/brands/{{podium[0].brand?.url}}.svg" title="{{podium[0].brand?.name}}" alt="{{podium[0].brand?.name}}"
            onerror="if (this.src != 'assets/brands/no-brand.svg') this.src = 'assets/brands/no-brand.svg'" class="brand-image-title">
          </div>
          <div *ngIf="podium[0]" class="nome">
            <span>{{podium[0].brand?.name}}</span> <strong>{{podium[0].name}}</strong>
          </div>

          <div *ngIf="!podium[0]" class="marca">
            <img src="assets/brands/no-brand.svg" title="Nenhum ainda" alt="Nenhum ainda" class="brand-image-title">
          </div>
          <div *ngIf="!podium[0]" class="nome">
            <strong>Nenhum Ainda!</strong>
          </div>
        </div>
        <div class="position bottom"></div>
      </div>
      <div class="car">
        <div class="nota nota-third">
          <ion-label *ngIf="podium[2]">
            <ion-icon name="ribbon" color="dark"></ion-icon>
            <strong>{{podium[2].model_average?.toFixed(2)}}</strong>{{podium[2].average?.name}}<br>
          </ion-label>

          <ion-label *ngIf="!podium[2]" class="no-car">
            <ion-icon name="ribbon" color="dark"></ion-icon>
            <strong>0.0</strong>Nenhum<br>
          </ion-label>
        </div>
        <div class="car-img-container">
          <img *ngIf="!podium[2]" class="no-car" [id]="'item-img-no-car-3'" src="assets/models/no-model.png" title="Nenhum carro no momento" alt="Nenhum carro no momento">
          <img *ngIf="podium[2]" [id]="'item-img-'+podium[2].name" src="assets/models/{{podium[2].brand?.url}}/{{podium[2].url}}/{{podium[2].img}}"
            title="{{podium[2].brand?.name + ' ' + podium[2].name}}" alt="{{podium[2].brand?.name + ' ' + podium[2].name}}"
            onerror="if (this.src != 'assets/models/no-model.png') this.src = 'assets/models/no-model.png'" (click)="clickCarItem($event, podium[2].brand?.url, podium[2]?.url)">
        </div>
        <div class="position right top third bottom">
          <div *ngIf="podium[2]" class="marca">
            <img src="assets/brands/{{podium[2].brand?.url}}.svg" title="{{podium[2].brand?.name}}" alt="{{podium[2].brand?.name}}"
            onerror="if (this.src != 'assets/brands/no-brand.svg') this.src = 'assets/brands/no-brand.svg'" class="brand-image-title">
          </div>
          <div *ngIf="podium[2]" class="nome">
            <span>{{podium[2].brand?.name}}</span> <strong>{{podium[2].name}}</strong>
          </div>

          <div *ngIf="!podium[2]" class="marca">
            <img src="assets/brands/no-brand.svg" title="Nenhum ainda" alt="Nenhum ainda" class="brand-image-title">
          </div>
          <div *ngIf="!podium[2]" class="nome">
            <strong>Nenhum Ainda!</strong>
          </div>
        </div>
      </div>
    </div>

    <app-banner-home [brands]="searchService.getAllBrands()"></app-banner-home>
    <br>
    <ion-title size="large" color="primary" class="main-title">
      <ion-icon [name]="'list-outline'" color="secondary"></ion-icon>
      <ion-label>Ranking</ion-label>
    </ion-title>

    <ion-grid class="custom-filter">
      <ion-row>
        <ion-col size-lg="2" size-md="3" size-sm="6" size-xs="6">
          <ion-item lines="none">
            <ion-icon size="small" [name]="'pricetag'" color="dark"></ion-icon>
            <ion-select id="brandSelect" *ngIf="searchService.getAllBrands().length" interface="popover" (ionChange)="filterBrand($event)" placeholder="Marca">
              <ion-select-option value="allBrands">Todas</ion-select-option>
              <ion-select-option *ngFor="let brand of searchService.getAllBrands()" [value]="{name: brand.name, id: brand._id}">{{ brand.name }}</ion-select-option>
            </ion-select>
          </ion-item>
        </ion-col>

        <ion-col size-lg="2" size-md="3" size-sm="6" size-xs="6">
          <ion-item lines="none">
            <ion-icon size="small" [name]="'car'" color="dark"></ion-icon>
            <ion-select id="categorySelect" *ngIf="searchService.getAllCategories().length" interface="popover" (ionChange)="filterCategory($event)" placeholder="Carroceria">
              <ion-select-option value="allCategories">Todas</ion-select-option>
              <ion-select-option *ngFor="let category of searchService.getAllCategories()" [value]="{name: category.name, id: category._id}">{{ category.name }}</ion-select-option>
            </ion-select>
          </ion-item>
        </ion-col>

        <ion-col size-lg="8" size-md="6" size-sm="12" size-xs="12">
          <ion-item lines="none" class="year-range">
            <ion-note *ngIf="filterYearValue.lower > yearMinValue" slot="start" color="dark">De<br><strong>{{filterYearValue.lower}}</strong></ion-note>
            <ion-note *ngIf="filterYearValue.lower <= yearMinValue"slot="start" color="dark">Mais<br><strong>antigo</strong></ion-note>
            <ion-note slot="end" color="dark">até<br><strong>{{filterYearValue.upper}}</strong></ion-note>
          </ion-item>

          <ion-range [min]="yearMinValue" [max]="2025" [dualKnobs]="true" [value]="filterYearValue" (ionChange)="filterYear($event)" (ionKnobMoveEnd)="this.clearBestModels(); filterBestModels()"></ion-range>
        </ion-col>
      </ion-row>
    </ion-grid>

    <div class="active-filters" *ngIf="brandIdFilter || categoryIdFilter || showDateFilter">
      <ion-item lines="none" class="filter-title" *ngIf="brandIdFilter || categoryIdFilter || showDateFilter">
        <ion-icon size="small" [name]="'funnel-outline'" color="medium"></ion-icon>
        <ion-label color="medium">Filtro:</ion-label>
      </ion-item>

      <ion-item lines="none" *ngIf="brandIdFilter" title="Remover filtro de marca {{brandIdFilter.name}}" (click)="clearFilter('allBrands')">
        <ion-label color="medium">{{brandIdFilter.name}}</ion-label>
        <ion-icon size="small" [name]="'close-circle-outline'" color="medium"></ion-icon>
      </ion-item>

      <ion-item lines="none" *ngIf="categoryIdFilter" title="Remover filtro de carroceria {{categoryIdFilter.name}}"  (click)="clearFilter('allCategories')">
        <ion-label color="medium">{{categoryIdFilter.name}}</ion-label>
        <ion-icon size="small" [name]="'close-circle-outline'" color="medium"></ion-icon>
      </ion-item>

      <ion-item lines="none" *ngIf="showDateFilter" title="Remover filtro de {{filterYearValue.lower}} até {{filterYearValue.upper}}"  (click)="filterYear({detail: {value:{ lower: yearMinValue, upper: newerYear + 1 }}}); this.clearBestModels(); filterBestModels()">
        <ion-label color="medium">de {{filterYearValue.lower}} até {{filterYearValue.upper}}</ion-label>
        <ion-icon size="small" [name]="'close-circle-outline'" color="medium"></ion-icon>
      </ion-item>

      <ion-item lines="none" title="Limpar todos"  (click)="clearAllFilters()">
        <ion-label color="medium">Limpar</ion-label>
        <ion-icon size="small" [name]="'trash-outline'" color="medium"></ion-icon>
      </ion-item>
    </div>

    <div class="main-body">
      <ion-list>
        <ion-item *ngIf="!bestModels?.length && !showLoader" lines="none">
          <ion-icon name="alert-circle" color="medium" size="large" class="warning"></ion-icon>
          <br>
          <ion-label color="medium" class="ion-text-wrap">Não encontramos nada no momento. Volte mais tarde!</ion-label>
        </ion-item>

        <ion-item *ngFor="let model of bestModels; let i = index" class="item-button" routerDirection="root" (click)="clickCarItem($event, model.brand?.url, model?.url)" button>
          <ion-grid>
            <ion-row>
              <ion-col size-lg="0.5" size-md="1" size-sm="1" size-xs="1.5" class="model-position">
                <div class="position">{{i + 1}}</div>
              </ion-col>
              <ion-col size-lg="11" size-md="10" size-sm="10" size-xs="9" class="model-name">
                {{model.brand?.name}} <strong>{{model.name}}</strong>
              </ion-col>
              <ion-col size-lg="0.5" size-md="1" size-sm="1" size-xs="1.5">
                <img src="assets/brands/{{model.brand?.url}}.svg" title="{{model.brand?.name}}" alt="{{model.brand?.name}}" loading="lazy"
                  onerror="if (this.src != 'assets/brands/no-brand.svg') this.src = 'assets/brands/no-brand.svg'" class="brand-image-title">
              </ion-col>
            </ion-row>

            <ion-row>
              <ion-col size-lg="7" size-md="5.5" size-sm="4.25" size-xs="6">
                <img [id]="'item-img-'+model.name" src="assets/models/{{model.brand?.url}}/{{model.url}}/{{model.url}}-thumb.png" loading="lazy"
                  title="{{model.brand?.name + ' ' + model.name}}" alt="{{model.brand?.name + ' ' + model.name}}"
                  onerror="if (this.src != 'assets/models/no-model.png') this.src = 'assets/models/no-model.png'" class="model-image">
               </ion-col>
              <ion-col size-lg="5" size-md="6.5" size-sm="7.75" size-xs="6" class="car-data">
                <ion-row class="average-row average-small" [ngClass]="model.average?.id">
                  <ion-col size-md="12" size-sm="12" size-xs="12">
                    <app-valuation-bar [small]="true" [valuationId]="model.average?.id"></app-valuation-bar>
                  </ion-col>
                </ion-row>
                <ion-row class="car-info">
                  <ion-col size-lg="5" size-md="5" size-sm="6" size-xs="12">
                    <ion-label [id]="'item-label-average-'+model.brand?.name+model.name">
                      <ion-icon name="ribbon" color="dark"></ion-icon>
                      <strong>{{model.model_average?.toFixed(2)}}</strong>{{model.average?.name}}<br>
                    </ion-label>
                  </ion-col>
                  <ion-col size-lg="7" size-md="7" size-sm="6" size-xs="12">
                    <ion-label [id]="'item-label-length-'+model.brand?.name+model.name">
                      <ion-icon name="reader" color="dark"></ion-icon>
                      {{model.val_length}} {{model.val_length === 1 ? 'opinião' : 'opiniões' }}
                    </ion-label>
                  </ion-col>
                </ion-row>
              </ion-col>
            </ion-row>
          </ion-grid>
        </ion-item>
      </ion-list>
      <ion-infinite-scroll *ngIf="bestModels.length" (ionInfinite)="onIonInfinite($event)">
        <ion-infinite-scroll-content></ion-infinite-scroll-content>
      </ion-infinite-scroll>
    </div>
  </div>
</ion-content>
